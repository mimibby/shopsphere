{% extends 'base.html' %}
{% load static %}
{% block title %}Order History - ShopSphere{% endblock %}

{% block content %}
<h2 class="order-title">My Order History</h2>

<div class="order-history-container">
  {% if page_obj %}
    {% for order in page_obj %}
      <div class="order-block">
        <p><strong>Order ID:</strong> {{ order.id }} | <strong>Date:</strong> {{ order.created_at|date:"Y-m-d H:i" }}</p>

        {% for item in order.items.all %}
          <div class="product-review-block">
            <p><strong>{{ item.product.name }}</strong></p>

            {% if item.product.id in reviewed_products %}
              <p class="already-reviewed">You already reviewed this product.</p>
            {% else %}
              <form method="POST" action="{% url 'shop:submit_review_from_order' item.product.id %}">
                {% csrf_token %}
                <div class="form-group">
                  <label for="id_rating_{{ item.product.id }}">Rating:</label>
                  {{ review_form.rating.as_widget }}
                </div>
                <div class="form-group">
                  <label for="id_comment_{{ item.product.id }}">Comment:</label>
                  {{ review_form.comment.as_widget }}
                </div>
                <button type="submit" class="btn">Submit Review</button>
              </form>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% endfor %}

    <!-- Pagination -->
    <div class="pagination">
      {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}">« Prev</a>
      {% endif %}

      <span class="current-page">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}">Next »</a>
      {% endif %}
    </div>

  {% else %}
    <p class="no-orders">You have no past orders.</p>
  {% endif %}
</div>
{% endblock %}